<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Small Steps AR</title>

  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.2/dist/mindar-image.prod.js"></script>
  <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.2/dist/mindar-image-aframe.prod.js"></script>

  <style>
    @import url('https://fonts.cdnfonts.com/css/proxima-nova-2');

    body {
      margin: 0;
      overflow: hidden;
    }

    #app-title {
      position: absolute;
      top: 40px;
      right: 20px;
      font-size: 32px;
      color: #2F59A1;
      font-weight: bold;
      font-family: 'Proxima Nova', sans-serif;
      z-index: 1000;
      pointer-events: none;
      white-space: nowrap;
    }

    #back-button {
      position: absolute;
      top: 40px;
      left: 20px;
      background-color: rgba(47, 89, 161, 0.8);
      color: white;
      border: none;
      border-radius: 12px;
      padding: 10px 20px;
      font-size: 18px;
      font-weight: bold;
      font-family: 'Proxima Nova', sans-serif;
      cursor: pointer;
      z-index: 1001;
      transition: background-color 0.2s ease;
    }

    #back-button:hover {
      background-color: rgba(47, 89, 161, 1);
    }

    #back-button:active {
      transform: scale(0.95);
    }

    #menu-bar {
      position: absolute;
      bottom: 10px;
      left: 50%;
      transform: translateX(-50%);
      width: 90%;
      max-width: 400px;
      height: 70px;
      z-index: 1000;
    }

    #menu-bar svg {
      width: 100%;
      height: 100%;
    }

    .menu-btn {
      cursor: pointer;
      transition: transform 0.1s ease;
    }

    .menu-btn:active {
      transform: scale(0.95);
    }

    #loading-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: #b8dfa9;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      font-family: 'Proxima Nova', sans-serif;
    }

    #loading-screen.hidden {
      display: none;
    }

    #loading-text {
      font-size: 24px;
      color: #2F59A1;
      font-weight: bold;
      margin-top: 20px;
      text-align: center;
      padding: 0 20px;
    }

    .spinner {
      border: 4px solid rgba(47, 89, 161, 0.3);
      border-top: 4px solid #2F59A1;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    #error-message {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: rgba(255, 0, 0, 0.9);
      color: white;
      padding: 20px;
      border-radius: 10px;
      font-size: 16px;
      text-align: center;
      z-index: 2001;
      display: none;
      max-width: 80%;
      font-family: 'Proxima Nova', sans-serif;
    }

    #message {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 80px;
      color: #FFD700;
      font-weight: bold;
      display: none;
      z-index: 999;
      text-shadow: 4px 4px 8px rgba(0,0,0,0.8);
      font-family: Arial, sans-serif;
      pointer-events: none;
    }

    @keyframes fadeUp {
      0% {
        transform: translate(-50%, -50%) scale(0.5);
        opacity: 0;
      }
      20% {
        transform: translate(-50%, -50%) scale(1.2);
        opacity: 1;
      }
      100% {
        transform: translate(-50%, -100%) scale(1);
        opacity: 0;
      }
    }

    .show-message {
      display: block !important;
      animation: fadeUp 1.5s ease-out forwards;
    }
  </style>
</head>

<body>
  <!-- Loading Screen -->
  <div id="loading-screen">
    <div class="spinner"></div>
    <div id="loading-text">Loading AR Experience...</div>
  </div>

  <!-- Error Message -->
  <div id="error-message"></div>

  <button id="back-button" onclick="goBack()">‚Üê Back</button>
  <div id="app-title">Small Steps AR</div>
  <div id="menu-bar">
    <svg width="400" height="119" viewBox="0 0 400 119" fill="none" xmlns="http://www.w3.org/2000/svg">
      <rect width="400" height="119" rx="19" fill="#2F59A1"/>
      <!-- Home button -->
      <g class="menu-btn" id="btn-home">
        <path d="M69.8001 65.05H77.1999V78H69.8001V65.05ZM91.0484 50.4831L74.3988 41.2331C73.8387 40.9223 73.1613 40.9223 72.6012 41.2331L55.9516 50.4831C55.0591 50.979 54.7366 52.1054 55.2334 52.9988C55.5695 53.6058 56.201 53.9212 56.8503 53.9224V76.15C56.8503 77.1717 57.6787 78 58.7003 78H66.1002V63.2C66.1002 62.1783 66.9285 61.35 67.9501 61.35H79.0499C80.0715 61.35 80.8998 62.1783 80.8998 63.2V78H88.2997C89.3213 78 90.1497 77.1717 90.1497 76.15V53.9498C90.7995 53.9491 91.4291 53.6062 91.7666 52.9988C92.2634 52.1054 91.9409 50.979 91.0484 50.4831Z" fill="#BBF6E2"/>
      </g>
      <!-- Camera button (highlighted) -->
      <g class="menu-btn" id="btn-camera">
        <rect x="137" y="22" width="72" height="75" rx="19" fill="#BBF6E2"/>
        <path d="M192 47.8333H184.348L183.079 44.0256C182.443 42.1161 180.664 40.8333 178.652 40.8333H168.015C166.003 40.8333 164.223 42.1161 163.59 44.0234L162.318 47.8333H154.667C152.094 47.8333 150 49.9262 150 52.4999V75.8333C150 77.123 151.044 78.1666 152.333 78.1666H194.333C195.623 78.1666 196.667 77.123 196.667 75.8333V52.4999C196.667 49.9262 194.573 47.8333 192 47.8333ZM159.333 59.6368C158.045 59.6368 157 58.592 157 57.3034C157 56.0147 158.045 54.9701 159.333 54.9701C160.622 54.9701 161.667 56.0147 161.667 57.3034C161.667 58.592 160.622 59.6368 159.333 59.6368ZM173.333 71.1666C168.186 71.1666 164 66.9807 164 61.8333C164 56.6869 168.186 52.4999 173.333 52.4999C178.481 52.4999 182.667 56.6869 182.667 61.8333C182.667 66.9807 178.481 71.1666 173.333 71.1666Z" fill="#56B2E5"/>
        <path d="M173.333 66.5001C175.91 66.5001 178 64.4107 178 61.8334C178 59.2561 175.91 57.1667 173.333 57.1667C170.756 57.1667 168.667 59.2561 168.667 61.8334C168.667 64.4107 170.756 66.5001 173.333 66.5001Z" fill="#56B2E5"/>
      </g>
      <!-- Location button -->
      <g class="menu-btn" id="btn-location">
        <path d="M252.316 59.425C254.368 59.425 256.031 57.7618 256.031 55.7101C256.031 53.6584 254.368 51.9951 252.316 51.9951C250.264 51.9951 248.601 53.6584 248.601 55.7101C248.601 57.7618 250.264 59.425 252.316 59.425Z" fill="#BBF6E2"/>
        <path d="M263.381 45.5739C257.279 39.4754 247.353 39.4754 241.251 45.5739C238.296 48.5288 236.667 52.4596 236.667 56.639C236.667 60.8201 238.296 64.7491 241.251 67.704L251.003 77.4558C251.365 77.8186 251.841 78 252.316 78C252.791 78 253.266 77.8186 253.629 77.4558L263.381 67.704C266.336 64.7491 267.965 60.8201 267.965 56.639C267.965 52.4596 266.336 48.5288 263.381 45.5739ZM252.316 63.1401C248.218 63.1401 244.886 59.8079 244.886 55.7102C244.886 51.6125 248.218 48.2803 252.316 48.2803C256.414 48.2803 259.746 51.6125 259.746 55.7102C259.746 59.8079 256.414 63.1401 252.316 63.1401Z" fill="#BBF6E2"/>
      </g>
      <!-- Profile button -->
      <g class="menu-btn" id="btn-profile">
        <path fill-rule="evenodd" clip-rule="evenodd" d="M324.171 79.7303C325.302 79.9109 326.408 80 327.516 80C332.669 80 337.553 78.0114 341.259 74.3039C345.781 69.7804 347.769 63.5635 346.73 57.2111C345.395 49.1606 338.842 42.6051 330.793 41.2704C324.443 40.2304 318.204 42.219 313.705 46.7425C309.208 51.2637 307.218 57.4812 308.28 63.8353C309.615 71.8607 316.148 78.3956 324.171 79.7303ZM316.554 73.0836C316.417 72.9464 316.305 72.8344 316.171 72.7201H316.191V71.7944C316.191 68.0412 319.221 65.0102 322.951 65.0102H332.016C335.768 65.0102 338.796 68.064 338.796 71.7944V72.743C338.727 72.8116 338.661 72.8733 338.592 72.935C338.524 72.999 338.458 73.0607 338.389 73.127L338.32 73.1727C335.293 75.751 331.495 77.175 327.493 77.175C323.492 77.175 319.651 75.751 316.644 73.1498L316.554 73.0836ZM322.363 49.9976C323.675 48.505 325.505 47.6913 327.47 47.6913L327.493 47.7141C327.923 47.7141 328.375 47.737 328.805 47.8284C331.449 48.3244 333.643 50.5188 334.138 53.1634C334.591 55.5817 333.777 57.9795 331.947 59.5842C330.117 61.1682 327.608 61.6643 325.233 60.8963C323.288 60.2631 321.684 58.6585 321.051 56.7134C320.284 54.3179 320.759 51.8082 322.363 49.9976Z" fill="#BBF6E2"/>
      </g>
    </svg>
  </div>
  <div id="message">+30</div>

  <a-scene
    mindar-image="imageTargetSrc: targets.mind; autoStart: false; uiLoading: no; uiError: no; uiScanning: no; filterMinCF: 0.001; filterBeta: 0.01;"
    color-space="sRGB"
    renderer="colorManagement: true, physicallyCorrectLights"
    vr-mode-ui="enabled: false"
    device-orientation-permission-ui="enabled: false">

    <a-assets>
      <a-asset-item id="model" src="30-3d-icon.glb"></a-asset-item>
    </a-assets>

    <a-camera position="0 0 0" look-controls="enabled: false">
      <a-entity cursor="fuse: false; rayOrigin: mouse" raycaster="objects: .clickable; far: 10000"></a-entity>
    </a-camera>

    <a-entity mindar-image-target="targetIndex: 0" id="target">
      <a-entity
        id="arObject"
        gltf-model="#model"
        position="0 0 0"
        scale="0.01 0.01 0.01"
        rotation="0 0 0"
        animation="property: rotation; to: 0 360 0; loop: true; dur: 4000; easing: linear"
        class="clickable">
      </a-entity>
    </a-entity>

  </a-scene>

  <script>
    let collected = false;
    let targetVisible = false;

    const loadingScreen = document.getElementById('loading-screen');
    const loadingText = document.getElementById('loading-text');
    const errorMessage = document.getElementById('error-message');
    const message = document.getElementById('message');
    const sceneEl = document.querySelector('a-scene');

    // Show error function
    function showError(msg) {
      console.error('AR Error:', msg);
      errorMessage.textContent = msg;
      errorMessage.style.display = 'block';
      loadingScreen.classList.add('hidden');
    }

    // Global error handler
    window.addEventListener('error', (e) => {
      console.error('Page error:', e.message);
      if (!errorMessage.style.display || errorMessage.style.display === 'none') {
        showError('Failed to load AR. Please check your connection and try again.');
      }
    });

    // Check HTTPS (not required for localhost)
    const isSecure = window.location.protocol === 'https:' ||
                     window.location.hostname === 'localhost' ||
                     window.location.hostname === '127.0.0.1';

    if (!isSecure) {
      console.warn('Not using HTTPS - AR may not work on mobile');
      loadingText.textContent = 'Warning: HTTPS required for camera access';
    }

    // A-Frame scene loaded
    sceneEl.addEventListener('loaded', async () => {
      console.log('A-Frame scene loaded');
      loadingText.textContent = 'Requesting camera access...';

      try {
        // Start MindAR manually
        const mindAR = sceneEl.systems['mindar-image-system'];
        if (mindAR) {
          await mindAR.start();
          console.log('MindAR started successfully');
        }
      } catch (error) {
        console.error('Failed to start MindAR:', error);
        showError('Camera access denied or not available. Please grant camera permissions and refresh.');
      }
    });

    // MindAR ready
    sceneEl.addEventListener('arReady', () => {
      console.log('AR Ready!');
      loadingScreen.classList.add('hidden');
    });

    // MindAR error
    sceneEl.addEventListener('arError', (e) => {
      console.error('AR Error event:', e);
      showError('AR failed to start. Make sure you granted camera permissions and are using HTTPS.');
    });

    // Fallback: Hide loading screen after 15 seconds if no events fired
    setTimeout(() => {
      if (!loadingScreen.classList.contains('hidden')) {
        console.log('Hiding loading screen (timeout)');
        loadingScreen.classList.add('hidden');
        // Show a gentle reminder if AR didn't start
        if (!targetVisible) {
          loadingText.textContent = 'If you see a black screen, please refresh and grant camera permissions.';
          loadingScreen.classList.remove('hidden');
          setTimeout(() => {
            loadingScreen.classList.add('hidden');
          }, 5000);
        }
      }
    }, 15000);

    const target = document.getElementById('target');
    const arObject = document.getElementById('arObject');

    target.addEventListener('targetFound', () => {
      targetVisible = true;
      collected = false;
      console.log('Target detected - tap the 3D object!');
    });

    target.addEventListener('targetLost', () => {
      targetVisible = false;
      console.log('Target lost');
    });

    // Tap directly on the 3D object
    arObject.addEventListener('click', (event) => {
      event.stopPropagation();
      console.log('3D object tapped!');

      if (targetVisible && !collected) {
        collected = true;

        message.classList.remove('show-message');
        void message.offsetWidth;
        message.classList.add('show-message');

        setTimeout(() => {
          message.classList.remove('show-message');
        }, 1500);

        // Stop the idle rotation and do collect spin
        arObject.removeAttribute('animation');
        arObject.setAttribute('animation__collect', {
          property: 'rotation',
          to: '0 720 0',
          dur: 1000,
          easing: 'easeInOutQuad'
        });

        arObject.setAttribute('animation__scale', {
          property: 'scale',
          to: '0.001 0.001 0.001',
          dur: 1000,
          easing: 'easeInQuad'
        });

        setTimeout(() => {
          arObject.setAttribute('visible', false);
        }, 1000);

        setTimeout(() => {
          arObject.setAttribute('visible', true);
          arObject.setAttribute('scale', '0.01 0.01 0.01');
          arObject.setAttribute('rotation', '0 0 0');
          arObject.removeAttribute('animation__collect');
          arObject.removeAttribute('animation__scale');
          // Restore idle rotation
          arObject.setAttribute('animation', 'property: rotation; to: 0 360 0; loop: true; dur: 4000; easing: linear');
          collected = false;
        }, 5000);
      }
    });

    // Back button navigation
    function goBack() {
      window.location.href = 'home.html';
    }

    // Menu button navigation
    document.getElementById('btn-home').addEventListener('click', () => {
      window.location.href = 'home.html';
    });

    document.getElementById('btn-camera').addEventListener('click', () => {
      // Already on AR page
      console.log('Already on AR page');
    });

    document.getElementById('btn-location').addEventListener('click', () => {
      console.log('Location page - coming soon');
    });

    document.getElementById('btn-profile').addEventListener('click', () => {
      console.log('Profile page - coming soon');
    });
  </script>
</body>
</html>
